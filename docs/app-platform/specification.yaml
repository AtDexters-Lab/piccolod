# specification.yaml â€” Piccolo OS App Manifest (pre-beta)
#
# Keep this file valid YAML. Delete sections you do not need; comments are for guidance.
#
# REQUIRED FIELDS -------------------------------------------------------------

name: dev-workspace            # Logical app identifier (dependency graph, UI labels). Keep unique.
image: ubuntu:22.04            # Provide either image: (pull from registry) or build: (see below).
# build:
#   containerfile: |          # Inline Containerfile when uploading sources through the API
#     FROM node:18
#     WORKDIR /app
#     COPY package*.json ./
#     RUN npm ci
#     COPY . .
#     CMD ["npm", "start"]
#   context: .                 # Optional build context path (defaults to current directory)
#   build_args:                # Optional key/value build arguments
#     NODE_ENV: production
#   # git: https://github.com/org/repo.git   # Breadcrumb: remote repo builds land post pre-beta
#   # branch: main

type: user                     # user (default, starts after unlock) | system (starts during boot)

# LISTENERS -------------------------------------------------------------------
# Each listener defines a service Piccolo proxies. piccolod allocates host + proxy ports.
# Remote access: https://<listener>.<user-domain>[:remote_port].
# Local portal: http(s)://<portal-host>:<allocated_port>.
# If remote_ports omitted, Piccolo advertises ports 80 and 443.
listeners:
  - name: web                  # DNS-safe service slug. Forms remote host "https://web.<user-domain>".
    # aliases: []              # Breadcrumb: future release allows extra FQDNs per listener
    guest_port: 8080           # In-container port to forward
    flow: tcp                  # tcp = Piccolo terminates TLS; tls = passthrough to the container
    protocol: http             # Hint for health/metrics (http | websocket | raw | ...). Defaults to raw.
    remote_ports: [80, 443]    # Optional explicit list of proxy ports for remote publish
    # protocol_middleware:      # Future extension: ordered middleware pipeline (auth, rate limit, ...)
    #   - name: enforce_private_auth

  - name: ssh                   # Additional listener example
    guest_port: 22
    flow: tcp
    protocol: raw              # raw = minimal proxying (default)
    remote_ports: [22]

# STORAGE ---------------------------------------------------------------------
# Persistent volumes survive container restarts and live under /var/piccolo/storage/<app>/<volume>.
# Temporary volumes map to /tmp/piccolo/... and reset on restart.
storage:
  persistent:
    projects:
      container: /workspace/projects
      size_limit: 50GB         # Optional quota (accepts B, KB, MB, GB, TB)
  temporary:
    build-cache:
      container: /workspace/build
      size_limit: 10GB

# FILESYSTEM ------------------------------------------------------------------
# Controls whether the container root filesystem is immutable between runs.
filesystem:
  persistent: false            # false (default) keeps the root reset on restart; true enables overlay persistence

# PERMISSIONS -----------------------------------------------------------------
# Omit to accept Piccolo defaults (internet denied, LAN allowed, root read-only).
permissions:
  network:
    internet: allow            # allow | deny
    local_network: allow       # allow access to LAN services (default: allow)
    dns: allow
    allowed_domains:
      - "github.com"          # Whitelist specific domains when internet: deny
      - "registry.npmjs.org"
  resources:
    max_processes: 200
    max_open_files: 2048
    privileged: false          # true grants additional Linux capabilities and should be avoided
  filesystem:
    read_only_root: false      # false permits writes when filesystem.persistent: true
    device_access: deny        # allow | deny access to /dev devices

# ENVIRONMENT -----------------------------------------------------------------
# Arbitrary string map injected into the container at runtime.
environment:
  NODE_ENV: development
  DATABASE_HOST: postgres.piccolo.local

# RESOURCE LIMITS --------------------------------------------------------------
resources:
  limits:
    memory: 4GB               # Memory limit per container
    cpu: 2.0                  # CPU cores (fractional allowed)
    storage: 100GB            # Aggregate persistent storage quota (across volumes)

# HEALTH MONITORING ------------------------------------------------------------
healthcheck:
  http:
    path: /health              # HTTP path queried by Piccolo
    port: web                  # Listener name to route the probe through
    timeout: 30s
    retries: 3

# DEPENDENCY GRAPH -------------------------------------------------------------
depends_on:
  - postgres
  - redis

# APP CONFIG ------------------------------------------------------------------
# Free-form YAML copied to /piccolo/config/app.yaml inside the container.
app_config:
  services:
    jupyter:
      enabled: true
      port: 8888

# EXTENSIONS ------------------------------------------------------------------
# Reserved namespace for future Piccolo-specific features; safe to omit.
x-piccolo: {}
